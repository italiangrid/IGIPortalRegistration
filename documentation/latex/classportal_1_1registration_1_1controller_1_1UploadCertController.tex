\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController}{
\section{portal.registration.controller.UploadCertController Class Reference}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController}\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
}


Collaboration diagram for portal.registration.controller.UploadCertController:
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
String \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_ac913a3594756b96ed7f0fcd84554db1d}{showUploadCert} (RenderResponse response)
\item 
void \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_aabfea247d5dc60c807432e5c7d097b88}{uploadCert} (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)  throws PortalException, 			SystemException 
\item 
void \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_ae16df287c878b7a8539deca62dae4fa0}{setDefaultCert} (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)
\item 
void \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_a93445bb06f7dc882972b7ca3f77cb152}{removeCert} (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)
\end{DoxyCompactItemize}
\subsection*{Private Member Functions}
\begin{DoxyCompactItemize}
\item 
String \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_aee6346cc2b1fde64774735838e5f3011}{myOpenssl} (String opt, String filename, ArrayList$<$ String $>$ errors)
\item 
void \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_a527883177a6f0d3525c6fe54bd41d323}{deleteUploadedFile} (ArrayList$<$ String $>$ files)
\end{DoxyCompactItemize}
\subsection*{Private Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{interfaceportal_1_1registration_1_1services_1_1CertificateService}{CertificateService} \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_a3e02549430f2fa9c54b2d8d620ac1166}{certificateService}
\end{DoxyCompactItemize}
\subsection*{Static Private Attributes}
\begin{DoxyCompactItemize}
\item 
static final Logger \hyperlink{classportal_1_1registration_1_1controller_1_1UploadCertController_ad52031d20516c6accce86ff8e44526d1}{log}
\end{DoxyCompactItemize}


\subsection{Detailed Description}


Definition at line 47 of file UploadCertController.java.



\subsection{Member Function Documentation}
\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_a527883177a6f0d3525c6fe54bd41d323}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!deleteUploadedFile@{deleteUploadedFile}}
\index{deleteUploadedFile@{deleteUploadedFile}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{deleteUploadedFile}]{\setlength{\rightskip}{0pt plus 5cm}void portal.registration.controller.UploadCertController.deleteUploadedFile (
\begin{DoxyParamCaption}
\item[{ArrayList$<$ String $>$}]{files}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}private\mbox{]}}}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_a527883177a6f0d3525c6fe54bd41d323}


Definition at line 389 of file UploadCertController.java.


\begin{DoxyCode}
                                                                 {
                try {
                        String cmd = "rm -f /upload_files/" + files.get(0)
                                        + " /upload_files/" + files.get(1);
                        log.info("cmd = " + cmd);
                        Runtime.getRuntime().exec(cmd);

                } catch (IOException e) {

                        e.printStackTrace();
                }
        }
\end{DoxyCode}
\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_aee6346cc2b1fde64774735838e5f3011}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!myOpenssl@{myOpenssl}}
\index{myOpenssl@{myOpenssl}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{myOpenssl}]{\setlength{\rightskip}{0pt plus 5cm}String portal.registration.controller.UploadCertController.myOpenssl (
\begin{DoxyParamCaption}
\item[{String}]{opt, }
\item[{String}]{filename, }
\item[{ArrayList$<$ String $>$}]{errors}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}private\mbox{]}}}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_aee6346cc2b1fde64774735838e5f3011}


Definition at line 294 of file UploadCertController.java.


\begin{DoxyCode}
                                                  {
                String result = null;

                try {
                        String cmd = "/usr/bin/openssl x509 -in /upload_files/" +
       filename
                                        + " -" + opt + " -noout";
                        log.info("cmd = " + cmd);
                        Process p = Runtime.getRuntime().exec(cmd);
                        InputStream stdout = p.getInputStream();
                        InputStream stderr = p.getErrorStream();

                        BufferedReader output = new BufferedReader(new InputStrea
      mReader(
                                        stdout));
                        String line = null;
                        int posizione;

                        int cursore = (opt.equals("subject") || opt.equals("issue
      r")) ? 2
                                        : 1;

                        while ((line = output.readLine()) != null) {
                                log.info("[Stdout] " + line);
                                if ((posizione = line.indexOf("=")) != -1) {
                                        result = line.substring(posizione + curso
      re);
                                        log.info(opt + " = " + result);
                                }
                        }
                        output.close();

                        BufferedReader brCleanUp = new BufferedReader(
                                        new InputStreamReader(stderr));
                        while ((line = brCleanUp.readLine()) != null) {
                                errors.add("no-valid-cert-" + opt);
                                log.info("[Stderr] " + line);
                        }
                        brCleanUp.close();

                } catch (IOException e) {

                        e.printStackTrace();
                }

                return result;
        }
\end{DoxyCode}
\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_a93445bb06f7dc882972b7ca3f77cb152}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!removeCert@{removeCert}}
\index{removeCert@{removeCert}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{removeCert}]{\setlength{\rightskip}{0pt plus 5cm}void portal.registration.controller.UploadCertController.removeCert (
\begin{DoxyParamCaption}
\item[{ActionRequest}]{request, }
\item[{ActionResponse}]{response, }
\item[{SessionStatus}]{sessionStatus}
\end{DoxyParamCaption}
)}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_a93445bb06f7dc882972b7ca3f77cb152}


Definition at line 366 of file UploadCertController.java.



References portal.registration.services.CertificateService.delete().


\begin{DoxyCode}
                                                     {

                int idCert = Integer.parseInt(request.getParameter("idCert"));
                String userId = request.getParameter("userId");

                try {
                        log.info("Sto per cancellare il certificato con id = " + 
      idCert);
                        certificateService.delete(idCert);
                        log.info("Certificato cancellato");

                        SessionMessages.add(request, "certificate-deleted-success
      ufully");

                } catch (Exception e) {
                        SessionErrors.add(request, "error-deleting-certificate");
      
                }

                response.setRenderParameter("myaction", "editUserInfoForm");
                response.setRenderParameter("userId", userId);
                sessionStatus.setComplete();

        }
\end{DoxyCode}


Here is the call graph for this function:


\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_ae16df287c878b7a8539deca62dae4fa0}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!setDefaultCert@{setDefaultCert}}
\index{setDefaultCert@{setDefaultCert}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{setDefaultCert}]{\setlength{\rightskip}{0pt plus 5cm}void portal.registration.controller.UploadCertController.setDefaultCert (
\begin{DoxyParamCaption}
\item[{ActionRequest}]{request, }
\item[{ActionResponse}]{response, }
\item[{SessionStatus}]{sessionStatus}
\end{DoxyParamCaption}
)}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_ae16df287c878b7a8539deca62dae4fa0}


Definition at line 340 of file UploadCertController.java.



References portal.registration.services.CertificateService.setDefault().


\begin{DoxyCode}
                                                     {

                int idCert = Integer.parseInt(request.getParameter("idCert"));
                String userId = request.getParameter("userId");

                try {
                        log.info("Sto per cancellare il certificato con id = " + 
      idCert);
                        if (certificateService.setDefault(idCert))
                                SessionMessages.add(request,
                                                "certificate-updated-successufull
      y");
                        else
                                SessionErrors.add(request, "error-default-certifi
      cate");
                        log.info("Certificato cancellato");

                } catch (Exception e) {
                        SessionErrors.add(request, "error-updating-certificate");
      
                }

                response.setRenderParameter("myaction", "editUserInfoForm");
                response.setRenderParameter("userId", userId);
                sessionStatus.setComplete();

        }
\end{DoxyCode}


Here is the call graph for this function:


\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_ac913a3594756b96ed7f0fcd84554db1d}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!showUploadCert@{showUploadCert}}
\index{showUploadCert@{showUploadCert}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{showUploadCert}]{\setlength{\rightskip}{0pt plus 5cm}String portal.registration.controller.UploadCertController.showUploadCert (
\begin{DoxyParamCaption}
\item[{RenderResponse}]{response}
\end{DoxyParamCaption}
)}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_ac913a3594756b96ed7f0fcd84554db1d}


Definition at line 56 of file UploadCertController.java.


\begin{DoxyCode}
                                                              {
                return "uploadCert";
        }
\end{DoxyCode}
\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_aabfea247d5dc60c807432e5c7d097b88}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!uploadCert@{uploadCert}}
\index{uploadCert@{uploadCert}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{uploadCert}]{\setlength{\rightskip}{0pt plus 5cm}void portal.registration.controller.UploadCertController.uploadCert (
\begin{DoxyParamCaption}
\item[{ActionRequest}]{request, }
\item[{ActionResponse}]{response, }
\item[{SessionStatus}]{sessionStatus}
\end{DoxyParamCaption}
)  throws PortalException, 			SystemException }}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_aabfea247d5dc60c807432e5c7d097b88}


Definition at line 61 of file UploadCertController.java.



References portal.registration.domain.Certificate.equals(), portal.registration.services.CertificateService.findById(), portal.registration.services.CertificateService.save(), portal.registration.domain.Certificate.setCaonline(), portal.registration.domain.Certificate.setExpirationDate(), portal.registration.domain.Certificate.setIdCert(), portal.registration.domain.Certificate.setIssuer(), portal.registration.domain.Certificate.setPrimaryCert(), portal.registration.domain.Certificate.setSubject(), and portal.registration.utils.MyValidator.validateCert().


\begin{DoxyCode}
                                        {

                ArrayList<String> errors = new ArrayList<String>();
                boolean allOk = true;

                HttpServletRequest req = PortalUtil.getHttpServletRequest(request
      );

                if (req != null) {
                        log.info("yessssss req");
                } else {
                        log.info("noooooo disastro req");
                }

                String ns = response.getNamespace();
                String primaryCert = null;
                String pwd = null;
                String pwd1 = null;
                String pwd2 = null;
                String username = null;
                String firstReg = null;
                ArrayList<String> files = new ArrayList<String>();
                int uid = 0;

                File dir = new File("/upload_files");
                if (dir.isDirectory()) {

                        if (ServletFileUpload.isMultipartContent(req)) {
                                log.info("yessssss" + ServletFileUpload.isMultipa
      rtContent(req));
                                try {
                                        MultipartParser mp = new MultipartParser(
      req,
                                                        1 * 1024 * 1024); // 10MB
      
                                        Part part;
                                        while ((part = mp.readNextPart()) != null
      ) {
                                                String name = part.getName();
                                                if (part.isParam()) {
                                                        ParamPart paramPart = (Pa
      ramPart) part;
                                                        String value = paramPart.
      getStringValue();
                                                        if (name.equals(ns + "pas
      sword"))
                                                                pwd1 = value;
                                                        if (name.equals(ns + "pas
      swordVerify"))
                                                                pwd2 = value;
                                                        if (name.equals(ns + "use
      rname"))
                                                                username = value;
      
                                                        if (name.equals(ns + "use
      rId"))
                                                                uid = Integer.par
      seInt(value);
                                                        if (name.equals(ns + "key
      Pass"))
                                                                pwd = value;
                                                        if (name.equals(ns + "pri
      maryCert"))
                                                                primaryCert = val
      ue;
                                                        if (name.equals(ns + "fir
      stReg"))
                                                                firstReg = value;
      
                                                        log.info("param; name=" +
       name + ", value=" + value);
                                                } else if (part.isFile()) {
                                                        // it's a file part
                                                        FilePart filePart = (File
      Part) part;
                                                        String fileName = filePar
      t.getFileName();
                                                        if (fileName != null) {
                                                                // the part actua
      lly contained a file
                                                                long size = fileP
      art.writeTo(dir);
                                                                log.info("file; n
      ame=" + name + "; filename="
                                                                                +
       fileName + ", filePath="
                                                                                +
       filePart.getFilePath()
                                                                                +
       ", content type="
                                                                                +
       filePart.getContentType() + ", size="
                                                                                +
       size);
                                                                files.add(fileNam
      e);
                                                        } else {
                                                                // the field did 
      not contain a file
                                                                log.info("file; n
      ame=" + name + "; EMPTY");
                                                        }
                                                }
                                        }

                                } catch (IOException lEx) {
                                        allOk = false;
                                        log.info("error reading or saving file");
      
                                }

                        } else {
                                allOk = false;
                                log.info("nooooooo "
                                                + ServletFileUpload.isMultipartCo
      ntent(req));
                        }

                } else {
                        allOk = false;
                        log.info("non è un a directory");
                }

                if (MyValidator.validateCert(pwd, pwd1, pwd2, errors) && allOk) {
      
                        // controllo file

                        // esecuzione myproxy

                        /*
                         * try { Runtime.getRuntime().exec("/bin/chmod 600 /uploa
      d_files/" +
                         * files.get(1)); String myproxy =
                         * "/usr/bin/python /upload_files/myproxy2.py " + usernam
      e +
                         * " /upload_files/" + files.get(0) + " /upload_files/" +
      
                         * files.get(1) + " " + pwd + " " + pwd1;
                         * log.info("Myproxy command = " + myproxy); Process p =
                         * Runtime.getRuntime().exec(myproxy); InputStream stdout
       =
                         * p.getInputStream(); InputStream stderr = p.getErrorStr
      eam ();
                         * 
                         * 
                         * BufferedReader output = new BufferedReader (new InputS
      treamReader
                         * (stdout)); String line = null;
                         * 
                         * while (((line = output.readLine ()) != null)) {
                         * 
                         * log.info("[Stdout] " + line); if(line.equals("myproxy 
      success")){
                         * log.info("myproxy ok"); pwd+="\n"; }
                         * if(line.equals("myproxy verify password failure")){
                         * log.info(line); allOk = false; }
                         * if(line.equals("myproxy password userkey failure")){
                         * log.info(line); allOk = false; } } output.close();
                         * 
                         * BufferedReader brCleanUp = new BufferedReader (new
                         * InputStreamReader (stderr)); while ((line = brCleanUp.
      readLine
                         * ()) != null) { allOk = false; log.info ("[Stderr] " + 
      line); }
                         * if(!allOk) errors.add("myproxy-error"); brCleanUp.clos
      e(); }
                         * catch (IOException e1) { allOk = false;
                         * errors.add("myproxy-exception"); e1.printStackTrace();
       }
                         */

                        String subject = myOpenssl("subject", files.get(0), error
      s);
                        String issuer = myOpenssl("issuer", files.get(0), errors)
      ;
                        String enddate = myOpenssl("enddate", files.get(0), error
      s);

                        if ((subject != null) && (issuer != null) && (enddate != 
      null)
                                        && allOk) {
                                Date date = null;

                                try {
                                        DateFormat formatter = new SimpleDateForm
      at(
                                                        "MMM dd HH:mm:ss yyyy z")
      ;
                                        date = (Date) formatter.parse(enddate);

                                        log.info("data formattata = " + date.toSt
      ring());
                                        GregorianCalendar c = new GregorianCalend
      ar();
                                        Date oggi = c.getTime();
                                        log.info("data oggi = " + oggi.toString()
      );

                                        if (date.before(oggi)) {
                                                log.info("Certificato scaduto");
                                                errors.add("user-certificate-expi
      red");
                                                allOk = false;
                                        } else {
                                                log.info("Certificato valido");
                                        }

                                } catch (ParseException e) {
                                        allOk = false;
                                        log.info("Eccezzione data");
                                }
                                if (allOk) {
                                        Certificate cert = new Certificate();
                                        cert.setIdCert(0);
                                        cert.setCaonline("false");
                                        cert.setExpirationDate(date);
                                        cert.setIssuer(issuer);
                                        cert.setPrimaryCert(primaryCert);
                                        cert.setSubject(subject);

                                        List<Certificate> lc = 
      certificateService.findById(uid);
                                        int i = 0;
                                        for (i = 0; i < lc.size(); i++) {
                                                if (cert.equals(lc.get(i))) {
                                                        allOk = false;
                                                        errors.add("certificate-d
      uplicate");
                                                        break;
                                                }

                                        }
                                        if (allOk) {
                                                int id = certificateService.save(
      cert, uid);

                                                if (id != -1) {
                                                        log.info("inserito il cer
      tificato per l'utente con userId = "
                                                                        + uid);
                                                } else {
                                                        allOk = false;
                                                }
                                        }
                                }
                        } else {
                                log.info("errori vari");
                                allOk = false;
                        }
                }

                log.info("controllo errori");
                if (allOk) {

                        log.info("tutto ok!!");
                        SessionMessages.add(request, "upload-cert-successufully")
      ;

                        if (firstReg.equals("true")) {
                                response.setRenderParameter("myaction",
                                                "showAddUserToVoPresents");
                                response.setRenderParameter("userId", Integer.toS
      tring(uid));
                                request.setAttribute("userId", uid);

                        } else {
                                response.setRenderParameter("myaction", "editUser
      InfoForm");
                                response.setRenderParameter("userId", Integer.toS
      tring(uid));
                        }

                } else {

                        log.info("Trovato errori");
                        errors.add("error-uploading-certificate");

                        for (String error : errors) {
                                log.info("Errore: " + error);
                                SessionErrors.add(request, error);
                        }

                        sessionStatus.setComplete();
                        response.setRenderParameter("myaction", "showUploadCert")
      ;
                        request.setAttribute("userId", uid);
                        request.setAttribute("username", username);
                        request.setAttribute("password", pwd1);
                        request.setAttribute("passwordVerify", pwd2);

                }

                deleteUploadedFile(files);

        }
\end{DoxyCode}


Here is the call graph for this function:




\subsection{Member Data Documentation}
\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_a3e02549430f2fa9c54b2d8d620ac1166}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!certificateService@{certificateService}}
\index{certificateService@{certificateService}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{certificateService}]{\setlength{\rightskip}{0pt plus 5cm}{\bf CertificateService} {\bf portal.registration.controller.UploadCertController.certificateService}\hspace{0.3cm}{\ttfamily  \mbox{[}private\mbox{]}}}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_a3e02549430f2fa9c54b2d8d620ac1166}


Definition at line 53 of file UploadCertController.java.

\hypertarget{classportal_1_1registration_1_1controller_1_1UploadCertController_ad52031d20516c6accce86ff8e44526d1}{
\index{portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}!log@{log}}
\index{log@{log}!portal::registration::controller::UploadCertController@{portal::registration::controller::UploadCertController}}
\subsubsection[{log}]{\setlength{\rightskip}{0pt plus 5cm}final Logger {\bf portal.registration.controller.UploadCertController.log}\hspace{0.3cm}{\ttfamily  \mbox{[}static, private\mbox{]}}}}
\label{classportal_1_1registration_1_1controller_1_1UploadCertController_ad52031d20516c6accce86ff8e44526d1}
{\bfseries Initial value:}
\begin{DoxyCode}
 Logger
                        .getLogger(UploadCertController.class)
\end{DoxyCode}


Definition at line 49 of file UploadCertController.java.



The documentation for this class was generated from the following file:\begin{DoxyCompactItemize}
\item 
/Users/mikel8/Documents/Uni/workspace/Registration/src/main/java/portal/registration/controller/\hyperlink{UploadCertController_8java}{UploadCertController.java}\end{DoxyCompactItemize}
