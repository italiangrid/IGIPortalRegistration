.TH "portal::registration::controller::UploadCertController" 3 "Wed Jul 13 2011" "Version 4" "Registration" \" -*- nroff -*-
.ad l
.nh
.SH NAME
portal::registration::controller::UploadCertController \- 
.SH SYNOPSIS
.br
.PP
.SS "Public Member Functions"

.in +1c
.ti -1c
.RI "String \fBshowUploadCert\fP (RenderResponse response)"
.br
.ti -1c
.RI "void \fBuploadCert\fP (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)  throws PortalException, 			SystemException "
.br
.ti -1c
.RI "void \fBsetDefaultCert\fP (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)"
.br
.ti -1c
.RI "void \fBremoveCert\fP (ActionRequest request, ActionResponse response, SessionStatus sessionStatus)"
.br
.in -1c
.SS "Private Member Functions"

.in +1c
.ti -1c
.RI "String \fBmyOpenssl\fP (String opt, String filename, ArrayList< String > errors)"
.br
.ti -1c
.RI "void \fBdeleteUploadedFile\fP (ArrayList< String > files)"
.br
.in -1c
.SS "Private Attributes"

.in +1c
.ti -1c
.RI "\fBCertificateService\fP \fBcertificateService\fP"
.br
.in -1c
.SS "Static Private Attributes"

.in +1c
.ti -1c
.RI "static final Logger \fBlog\fP"
.br
.in -1c
.SH "Detailed Description"
.PP 
Definition at line 47 of file UploadCertController.java.
.SH "Member Function Documentation"
.PP 
.SS "void portal.registration.controller.UploadCertController.deleteUploadedFile (ArrayList< String >files)\fC [private]\fP"
.PP
Definition at line 389 of file UploadCertController.java.
.PP
.nf
                                                                 {
                try {
                        String cmd = 'rm -f /upload_files/' + files.get(0)
                                        + ' /upload_files/' + files.get(1);
                        log.info('cmd = ' + cmd);
                        Runtime.getRuntime().exec(cmd);

                } catch (IOException e) {

                        e.printStackTrace();
                }
        }
.fi
.SS "String portal.registration.controller.UploadCertController.myOpenssl (Stringopt, Stringfilename, ArrayList< String >errors)\fC [private]\fP"
.PP
Definition at line 294 of file UploadCertController.java.
.PP
.nf
                                                  {
                String result = null;

                try {
                        String cmd = '/usr/bin/openssl x509 -in /upload_files/' + filename
                                        + ' -' + opt + ' -noout';
                        log.info('cmd = ' + cmd);
                        Process p = Runtime.getRuntime().exec(cmd);
                        InputStream stdout = p.getInputStream();
                        InputStream stderr = p.getErrorStream();

                        BufferedReader output = new BufferedReader(new InputStreamReader(
                                        stdout));
                        String line = null;
                        int posizione;

                        int cursore = (opt.equals('subject') || opt.equals('issuer')) ? 2
                                        : 1;

                        while ((line = output.readLine()) != null) {
                                log.info('[Stdout] ' + line);
                                if ((posizione = line.indexOf('=')) != -1) {
                                        result = line.substring(posizione + cursore);
                                        log.info(opt + ' = ' + result);
                                }
                        }
                        output.close();

                        BufferedReader brCleanUp = new BufferedReader(
                                        new InputStreamReader(stderr));
                        while ((line = brCleanUp.readLine()) != null) {
                                errors.add('no-valid-cert-' + opt);
                                log.info('[Stderr] ' + line);
                        }
                        brCleanUp.close();

                } catch (IOException e) {

                        e.printStackTrace();
                }

                return result;
        }
.fi
.SS "void portal.registration.controller.UploadCertController.removeCert (ActionRequestrequest, ActionResponseresponse, SessionStatussessionStatus)"
.PP
Definition at line 366 of file UploadCertController.java.
.PP
References portal.registration.services.CertificateService.delete().
.PP
.nf
                                                     {

                int idCert = Integer.parseInt(request.getParameter('idCert'));
                String userId = request.getParameter('userId');

                try {
                        log.info('Sto per cancellare il certificato con id = ' + idCert);
                        certificateService.delete(idCert);
                        log.info('Certificato cancellato');

                        SessionMessages.add(request, 'certificate-deleted-successufully');

                } catch (Exception e) {
                        SessionErrors.add(request, 'error-deleting-certificate');
                }

                response.setRenderParameter('myaction', 'editUserInfoForm');
                response.setRenderParameter('userId', userId);
                sessionStatus.setComplete();

        }
.fi
.SS "void portal.registration.controller.UploadCertController.setDefaultCert (ActionRequestrequest, ActionResponseresponse, SessionStatussessionStatus)"
.PP
Definition at line 340 of file UploadCertController.java.
.PP
References portal.registration.services.CertificateService.setDefault().
.PP
.nf
                                                     {

                int idCert = Integer.parseInt(request.getParameter('idCert'));
                String userId = request.getParameter('userId');

                try {
                        log.info('Sto per cancellare il certificato con id = ' + idCert);
                        if (certificateService.setDefault(idCert))
                                SessionMessages.add(request,
                                                'certificate-updated-successufully');
                        else
                                SessionErrors.add(request, 'error-default-certificate');
                        log.info('Certificato cancellato');

                } catch (Exception e) {
                        SessionErrors.add(request, 'error-updating-certificate');
                }

                response.setRenderParameter('myaction', 'editUserInfoForm');
                response.setRenderParameter('userId', userId);
                sessionStatus.setComplete();

        }
.fi
.SS "String portal.registration.controller.UploadCertController.showUploadCert (RenderResponseresponse)"
.PP
Definition at line 56 of file UploadCertController.java.
.PP
.nf
                                                              {
                return 'uploadCert';
        }
.fi
.SS "void portal.registration.controller.UploadCertController.uploadCert (ActionRequestrequest, ActionResponseresponse, SessionStatussessionStatus)  throws PortalException, 			SystemException "
.PP
Definition at line 61 of file UploadCertController.java.
.PP
References portal.registration.domain.Certificate.equals(), portal.registration.services.CertificateService.findById(), portal.registration.services.CertificateService.save(), portal.registration.domain.Certificate.setCaonline(), portal.registration.domain.Certificate.setExpirationDate(), portal.registration.domain.Certificate.setIdCert(), portal.registration.domain.Certificate.setIssuer(), portal.registration.domain.Certificate.setPrimaryCert(), portal.registration.domain.Certificate.setSubject(), and portal.registration.utils.MyValidator.validateCert().
.PP
.nf
                                        {

                ArrayList<String> errors = new ArrayList<String>();
                boolean allOk = true;

                HttpServletRequest req = PortalUtil.getHttpServletRequest(request);

                if (req != null) {
                        log.info('yessssss req');
                } else {
                        log.info('noooooo disastro req');
                }

                String ns = response.getNamespace();
                String primaryCert = null;
                String pwd = null;
                String pwd1 = null;
                String pwd2 = null;
                String username = null;
                String firstReg = null;
                ArrayList<String> files = new ArrayList<String>();
                int uid = 0;

                File dir = new File('/upload_files');
                if (dir.isDirectory()) {

                        if (ServletFileUpload.isMultipartContent(req)) {
                                log.info('yessssss' + ServletFileUpload.isMultipartContent(req));
                                try {
                                        MultipartParser mp = new MultipartParser(req,
                                                        1 * 1024 * 1024); // 10MB
                                        Part part;
                                        while ((part = mp.readNextPart()) != null) {
                                                String name = part.getName();
                                                if (part.isParam()) {
                                                        ParamPart paramPart = (ParamPart) part;
                                                        String value = paramPart.getStringValue();
                                                        if (name.equals(ns + 'password'))
                                                                pwd1 = value;
                                                        if (name.equals(ns + 'passwordVerify'))
                                                                pwd2 = value;
                                                        if (name.equals(ns + 'username'))
                                                                username = value;
                                                        if (name.equals(ns + 'userId'))
                                                                uid = Integer.parseInt(value);
                                                        if (name.equals(ns + 'keyPass'))
                                                                pwd = value;
                                                        if (name.equals(ns + 'primaryCert'))
                                                                primaryCert = value;
                                                        if (name.equals(ns + 'firstReg'))
                                                                firstReg = value;
                                                        log.info('param; name=' + name + ', value=' + value);
                                                } else if (part.isFile()) {
                                                        // it's a file part
                                                        FilePart filePart = (FilePart) part;
                                                        String fileName = filePart.getFileName();
                                                        if (fileName != null) {
                                                                // the part actually contained a file
                                                                long size = filePart.writeTo(dir);
                                                                log.info('file; name=' + name + '; filename='
                                                                                + fileName + ', filePath='
                                                                                + filePart.getFilePath()
                                                                                + ', content type='
                                                                                + filePart.getContentType() + ', size='
                                                                                + size);
                                                                files.add(fileName);
                                                        } else {
                                                                // the field did not contain a file
                                                                log.info('file; name=' + name + '; EMPTY');
                                                        }
                                                }
                                        }

                                } catch (IOException lEx) {
                                        allOk = false;
                                        log.info('error reading or saving file');
                                }

                        } else {
                                allOk = false;
                                log.info('nooooooo '
                                                + ServletFileUpload.isMultipartContent(req));
                        }

                } else {
                        allOk = false;
                        log.info('non è un a directory');
                }

                if (MyValidator.validateCert(pwd, pwd1, pwd2, errors) && allOk) {
                        // controllo file

                        // esecuzione myproxy

                        /*
                         * try { Runtime.getRuntime().exec('/bin/chmod 600 /upload_files/' +
                         * files.get(1)); String myproxy =
                         * '/usr/bin/python /upload_files/myproxy2.py ' + username +
                         * ' /upload_files/' + files.get(0) + ' /upload_files/' +
                         * files.get(1) + ' ' + pwd + ' ' + pwd1;
                         * log.info('Myproxy command = ' + myproxy); Process p =
                         * Runtime.getRuntime().exec(myproxy); InputStream stdout =
                         * p.getInputStream(); InputStream stderr = p.getErrorStream ();
                         * 
                         * 
                         * BufferedReader output = new BufferedReader (new InputStreamReader
                         * (stdout)); String line = null;
                         * 
                         * while (((line = output.readLine ()) != null)) {
                         * 
                         * log.info('[Stdout] ' + line); if(line.equals('myproxy success')){
                         * log.info('myproxy ok'); pwd+='\n'; }
                         * if(line.equals('myproxy verify password failure')){
                         * log.info(line); allOk = false; }
                         * if(line.equals('myproxy password userkey failure')){
                         * log.info(line); allOk = false; } } output.close();
                         * 
                         * BufferedReader brCleanUp = new BufferedReader (new
                         * InputStreamReader (stderr)); while ((line = brCleanUp.readLine
                         * ()) != null) { allOk = false; log.info ('[Stderr] ' + line); }
                         * if(!allOk) errors.add('myproxy-error'); brCleanUp.close(); }
                         * catch (IOException e1) { allOk = false;
                         * errors.add('myproxy-exception'); e1.printStackTrace(); }
                         */

                        String subject = myOpenssl('subject', files.get(0), errors);
                        String issuer = myOpenssl('issuer', files.get(0), errors);
                        String enddate = myOpenssl('enddate', files.get(0), errors);

                        if ((subject != null) && (issuer != null) && (enddate != null)
                                        && allOk) {
                                Date date = null;

                                try {
                                        DateFormat formatter = new SimpleDateFormat(
                                                        'MMM dd HH:mm:ss yyyy z');
                                        date = (Date) formatter.parse(enddate);

                                        log.info('data formattata = ' + date.toString());
                                        GregorianCalendar c = new GregorianCalendar();
                                        Date oggi = c.getTime();
                                        log.info('data oggi = ' + oggi.toString());

                                        if (date.before(oggi)) {
                                                log.info('Certificato scaduto');
                                                errors.add('user-certificate-expired');
                                                allOk = false;
                                        } else {
                                                log.info('Certificato valido');
                                        }

                                } catch (ParseException e) {
                                        allOk = false;
                                        log.info('Eccezzione data');
                                }
                                if (allOk) {
                                        Certificate cert = new Certificate();
                                        cert.setIdCert(0);
                                        cert.setCaonline('false');
                                        cert.setExpirationDate(date);
                                        cert.setIssuer(issuer);
                                        cert.setPrimaryCert(primaryCert);
                                        cert.setSubject(subject);

                                        List<Certificate> lc = certificateService.findById(uid);
                                        int i = 0;
                                        for (i = 0; i < lc.size(); i++) {
                                                if (cert.equals(lc.get(i))) {
                                                        allOk = false;
                                                        errors.add('certificate-duplicate');
                                                        break;
                                                }

                                        }
                                        if (allOk) {
                                                int id = certificateService.save(cert, uid);

                                                if (id != -1) {
                                                        log.info('inserito il certificato per l'utente con userId = '
                                                                        + uid);
                                                } else {
                                                        allOk = false;
                                                }
                                        }
                                }
                        } else {
                                log.info('errori vari');
                                allOk = false;
                        }
                }

                log.info('controllo errori');
                if (allOk) {

                        log.info('tutto ok!!');
                        SessionMessages.add(request, 'upload-cert-successufully');

                        if (firstReg.equals('true')) {
                                response.setRenderParameter('myaction',
                                                'showAddUserToVoPresents');
                                response.setRenderParameter('userId', Integer.toString(uid));
                                request.setAttribute('userId', uid);

                        } else {
                                response.setRenderParameter('myaction', 'editUserInfoForm');
                                response.setRenderParameter('userId', Integer.toString(uid));
                        }

                } else {

                        log.info('Trovato errori');
                        errors.add('error-uploading-certificate');

                        for (String error : errors) {
                                log.info('Errore: ' + error);
                                SessionErrors.add(request, error);
                        }

                        sessionStatus.setComplete();
                        response.setRenderParameter('myaction', 'showUploadCert');
                        request.setAttribute('userId', uid);
                        request.setAttribute('username', username);
                        request.setAttribute('password', pwd1);
                        request.setAttribute('passwordVerify', pwd2);

                }

                deleteUploadedFile(files);

        }
.fi
.SH "Member Data Documentation"
.PP 
.SS "\fBCertificateService\fP \fBportal.registration.controller.UploadCertController.certificateService\fP\fC [private]\fP"
.PP
Definition at line 53 of file UploadCertController.java.
.SS "final Logger \fBportal.registration.controller.UploadCertController.log\fP\fC [static, private]\fP"\fBInitial value:\fP
.PP
.nf
 Logger
                        .getLogger(UploadCertController.class)
.fi
.PP
Definition at line 49 of file UploadCertController.java.

.SH "Author"
.PP 
Generated automatically by Doxygen for Registration from the source code.
